---
title: 卡尔曼滤波公式推导
math: true
categories: 知识学习
---

<!--more-->

## 一、背景框架
$$
\begin{aligned}
x_k &= A_kx_{k-1}+B_ke_{k-1}+w_{k-1} \\
y_k &= C_kx_k + v_k
\end{aligned}
$$
假设 $w,v$ 均为高斯白噪声 $w_k\sim N(0, Q_k), v_k\sim N(0, R_k)$，并且相互独立
$$
\begin{aligned}
& E[w_k] = 0, E[v_kv_k^T] = R_k\\ 
& E[v_k] = 0, E[w_kw_k^T] = Q_k \\
& E[w_k^Tv_j] = 0
\end{aligned}
$$
## 二、基本思想：加权平均

新的状态估计值，要融合由上一状态估计值得到的递推值
$$
\hat{x}'_k = A_k\hat{x}_{k-1}+B_ke_{k-1}
$$
和由测量值反解出来的值
$$
\hat{x}''_k = C_k^{-1}y_k
$$
进行加权平均，得到新的状态估计值
$$
\hat{x}_k = (I-W_k)\hat{x}'_k + W_k\hat{x}''_k = \hat{x}'_k + W_k(\hat{x}''_k-\hat{x}'_k)
$$
令 $W_k = H_kC_k$，则
$$
\hat{x}_k = \hat{x}'_k + H_k(y_k-C_k\hat{x}'_k)
$$
接下来的问题就是，该如何确定 $H_k$ ？

## 三、最优估计(最小均方误差意义下)

令 $e_k = x_k - \hat{x}_k$ 为后验估计误差，我们的目标是，使得误差均方估计值最小，即 
$$
\min E[e_k^Te_k]
$$
令 $P_k = E[e_ke_k^T]$，为后验误差协方差矩阵，则 $E[e_k^Te_k] = tr(E[e_k^Te_k]) = tr(E[e_ke_k^T]) = tr(P_k)$

$e_k^- = x_k - \hat{x}_k'$ 为先验误差
$$
\begin{aligned}
e_k & = x_k -\hat{x}_k \\
    & = x_k - \hat{x}'_k - H_k(y_k-C_k\hat{x}'_k) \\
    & = x_k - \hat{x}'_k - H_k(C_kx_k + v_k -C_k\hat{x}'_k) \\
    & =  (I-H_kC_k)(x_k - \hat{x}'_k) - H_kv_k \\
    & = (I-H_kC_k)e_k^- - H_kv_k
\end{aligned}
$$

$$
P_k = E[e_ke_k^T] = (I-H_kC_k)E[e_k^- e_k^{-T}](I-H_kC_k)^T - (I-H_kC_k)E[e_k^-v_k^T]H_k^T-H_kE[v_ke_k^{-T}](I-H_kC_k)^T + H_kE[v_kv_k^T] H_k^T
$$

$P_k^- = E[e_k^- e_k^{-T}]$ 为先验误差 $e_k^-$ 的协方差矩阵，$R_k = E[v_kv_k^T]$ 为测量误差 $v_k$ 的协方差矩阵。由于先验误差 $e_k^-$ 和测量误差 $v_k$ 相互独立，故 $E[e_k^-v_k^T]=E[e_k^-]E[v_k^T]=0, E[v_ke_k^{-T}]=0, $ 因此上式为
$$
P_k =(I-H_kC_k)P_k^-(I-H_kC_k)^T + H_kR_k H_k^T
= P_k^- -P_k^-C_k^TH_k^T-H_kC_kP_k^-+H_k(C_kP_k^-C_k^T+R_k)H_k^T
$$
下面要用到如下三个公式
$$
\begin{aligned}
\frac{\partial tr(AB)}{\partial A} &=  \frac{\partial tr(BA)}{\partial A} = B^T \\
\frac{\partial tr(A^TB)}{\partial A} &=  \frac{\partial tr(BA^T)}{\partial A} = B \\
\frac{\partial tr(ABA^T)}{\partial A} & = AB^T + AB
\end{aligned}
$$

运用这两个公式，可得
$$
\frac{\partial tr(P_k)}{\partial H_k} = -P_k^-C_k^T - P_k^{-T}C_k^T +H_kC_kP_k^{-T}C_k^T + H_kC_kP_k^-C_k^T + H_kR_k^T + H_kR_k
$$
由于 $P_k^-, R_k$ 均为协方差矩阵，故对称，上式可简化为
$$
\frac{\partial tr(P_k)}{\partial H_k} = -2P_k^-C_k^T  + 2H_kC_kP_k^{-}C_k^T + 2 H_kR_k
$$
由于要求 $tr(P_k)$ 的最小值，令上式为零，等价于
$$
H_k(C_kP_k^{-}C_k^T + R_k) = P_k^-C_k^T
$$
解得
$$
H_k = P_k^-C_k^T(C_kP_k^{-}C_k^T + R_k)^{-1} = \frac{P_k^-C_k^T}{C_kP_k^{-}C_k^T + R_k}
$$
分析：

1. 若 $R_k\rightarrow 0$，则 $H_k = C_k^{-1}, k = I, \hat{x}_k = \hat{x}''_k = C_k^{-1}y_k$，完全相信测量值；
2. 若 $R_k\rightarrow \infty$，则 $H_k = 0, W_k = 0, \hat{x}_k = \hat{x}'_k  = A_k\hat{x}_{k-1}+B_ke_{k-1} $，完全相信递推值；



将 $H_k(C_kP_k^{-}C_k^T + R_k) = P_k^-C_k^T$ 表达式代入 $P_k$，得
$$
\begin{aligned}
P_k &= P_k^- -P_k^-C_k^TH_k^T -H_kC_kP_k^- +H_k(C_kP_k^-C_k^T+R_k)H_k^T \\
    &= P_k^- -H_kC_kP_k^- -P_k^-C_k^TH_k^T + H_k(C_kP_k^-C_k^T+R_k)H_k^T \\
    &= (I - H_kC_k)P_k^-
\end{aligned}
$$


$e_k^- = x_k - \hat{x}_k' = (A_kx_{k-1}+B_ke_{k-1}+w_{k-1}) - (A_k\hat{x}_{k-1}+B_ke_{k-1}) = A_k(x_{k-1} - \hat{x}_{k-1}) + w_{k-1} = Ae_{k-1}+w_{k-1}$
$$
\begin{aligned}
P_k^- &= E[e_k^-e_k^{-T}] \\
      &= E[(Ae_{k-1}+w_{k-1})(Ae_{k-1}+w_{k-1})^T] \\
      &= E[Ae_{k-1}e_{k-1}^TA^T] + E[w_{k-1}w_{k-1}^T] \\
      &= AP_{k-1}A^T + Q_{k-1}
\end{aligned}
$$

## 四、总结

至此，卡尔曼滤波所有公式推导完毕：

1. 先验估计
    $$
    \hat{x}'_k = A_k\hat{x}_{k-1}+B_ke_{k-1}
    $$

2. 先验误差协方差矩阵
    $$
    P_k^- = AP_{k-1}A^T + Q_{k-1}
    $$

3. 

3. 卡尔曼增益
    $$
    H_k = P_k^-C_k^T(C_kP_k^{-}C_k^T + R_k)^{-1}
    $$

4. 加权平均
    $$
    \hat{x}_k = \hat{x}'_k + H_k(y_k-C_k\hat{x}'_k)
    $$

5. 后验误差协方差矩阵
    $$
    P_k= (I - H_kC_k)P_k^-
    $$
